---
title: "Group 13 Final Project"
author: "cs3779, kd2640, ob2305, mp3745, lef2147"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output: html_document
---

Rough Outline of Project:

* Describe the goal/motivation of the project; have some stats and facts to explain our purpose in investigating this dataset
* Describe the dataset: where is it from, what does it contain
* Review the questions we intend on answering 
* Exploratory Data Analysis
  * Give an overview of the demographics of our dataset, any conclusion we make is only relevant to those who were stopped which is why it is good to give an idea of who is represented
    * histogram of race/build/etc.
    * distribution of continuous variables
  * Logistic Regression
    * odds of frisked
    * odds of arrest
  * Trends over time
    * could maybe find a way to test this, i.e. linear regression, is the slope equal to zero, or something of that nature. the plot shows a funnel pattern so maybe we could look into that more
  * other things
* Findings/Discussion




```{r setup, include=FALSE}
library(tidyverse)
library(viridis)
library(rvest)
library(httr)
library(lubridate)
library(plotly)
library(rgdal)
library(sp)
library(sf)
library(leaflet)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "bottom"))
```


Read in and tidy the data

The following code:

* Reads in the data
* Renames columns to be more informative
* Combines height columns into a single height in inches
* Converts date_stop to date data type
* Converts time_stop to time data type
* Recodes the values in categorical columns to be more informative
* Selects column subset for further analysis

```{r, message=FALSE}
# Read in data
stop_frisk_df = 
  # Read in data from internet
  GET("https://www1.nyc.gov/assets/nypd/downloads/excel/analysis_and_planning/stop-question-frisk/sqf-2016.csv") %>% 
  content("parsed") %>% 
  
  # Clean and fix names of columns
  janitor::clean_names() %>% 
  rename(
    precinct = pct,
    date_stop = datestop,
    time_stop = timestop,
    stop_in_out = inout,
    obs_time_min = perobs,
    stop_time_min = perstop,
    arst_made = arstmade,
    off_in_unif = offunif,
    hair_col = haircolr,
    eye_col = eyecolor,
    other_feature = othfeatr,
    boro = city
  )  %>% 
  mutate(
    # Combine height columns
    height_inch = ht_feet * 12 + ht_inch,
    # Convert date to proper format
    date_stop = mdy(date_stop),
    # Convert time to proper format
    time_stop = hm(time_stop / 100),
    # Recode to be more informative
    stop_in_out = recode(stop_in_out, "I" = "inside", "O" = "outside"),
    race = recode(
      race, 
      "A" = "asian/pacific islander", 
      "B" = "black", 
      "I" = "american indian/alaska native",
      "P" = "black-hispanic",
      "Q" = "white-hispanic",
      "W" = "white",
      "U" = "unknown",
      "Z" = "other"
    ),
    hair_col = recode(
      hair_col,
      "BA" = "bald",
      "BK" = "black",
      "BL" = "blond",
      "BR" = "brown",
      "DY" = "dyed",
      "FR" = "frosted",
      "GY" = "gray",
      "RA" = "red",
      "SN" = "sandy",
      "SP" = "salt and pepper",
      "WH" = "white",
      "XX" = "unknown",
      "ZZ" = "other",
    ),
    eye_col = recode(
      eye_col,
      "BK" = "black",
      "BL" = "blue",
      "BR" = "brown",
      "DF" = "different",
      "GR" = "green",
      "GY" = "gray",
      "HA" = "hazel",
      "MA" = "maroon",
      "PK" = "pink",
      "VI" = "violet",
      "XX" = "unknown",
      "Z" = "other",      
    ),
    build = recode(
      build,
      "H" = "heavy",
      "M" = "medium",
      "T" = "thin",
      "U" = "muscular",
      "Z" = "unknown"
    ),
    # change boro columns to lowercase for consistency
    boro = tolower(boro),
    # change character datatypes to numeric
    age = as.numeric(age),
    obs_time_min = as.numeric(obs_time_min),
    stop_time_min = as.numeric(stop_time_min)
  )  %>% 
  # select columns for further analysis
  select(precinct, date_stop, time_stop, stop_in_out, obs_time_min, stop_time_min, arst_made, off_in_unif, frisked, 
         searched, rf_vcrim, rf_othsw, rf_attir:ac_evasv, cs_furtv:cs_other, rf_knowl, sb_hdobj:sb_admis, rf_furt, 
         rf_bulg, sex, race, age, height_inch, weight:build, boro, xcoord, ycoord) %>% 
  # change all columns that have Y/N to 1/0
  mutate_at(vars(arst_made:rf_bulg), funs(recode(., "Y" = "1", "N" = "0"))) %>% 
  # change binary columns to numeric instead of character
  mutate_at(vars(arst_made:rf_bulg), funs(as.numeric(.))) %>% 
  # converts all character variables to factors (this does the same as the for loop)
  mutate_if(is.character, as.factor) %>% 
  # remove the single row of NAs
  filter(!is.na(build))
```


Evaluating Missing Data and Categorical Data
```{r}
table(stop_frisk_df$race)
table(stop_frisk_df$hair_col)
table(stop_frisk_df$eye_col)
table(stop_frisk_df$build)
# we should consider consolidating categories

colSums(is.na(stop_frisk_df))
# we should consider removing variable other_feature (11637 missing obs)
# age has 35 missing values, consider multiple imputation methods here

# Looks like there is also an entire row of NA's
```


Looking at stops over time 

* Over a year
* By time of day

```{r, message=FALSE}
# Number of stops per day
stop_frisk_df %>% 
  group_by(date_stop) %>% 
  summarize(
    count = n()
  ) %>% 
  ggplot(aes(x = date_stop, y = count)) + 
  geom_point() +
  geom_smooth(se = FALSE)

# Number of stops per month
stop_frisk_df %>% 
  mutate(
    month_stop = factor(month(date_stop))
  ) %>% 
  filter(
    month_stop != is_null(month_stop)
  ) %>% 
  group_by(month_stop) %>% 
  summarize(
    count = n()
  ) %>% 
  ggplot(aes(x = month_stop, y = count)) + 
  geom_bar(stat = "Identity") 

# Number of stops per day (broken down by boro)
stop_frisk_df %>% 
  mutate(
    month_stop = month(date_stop)
  ) %>% 
  filter(
    month_stop != is_null(month_stop)
  ) %>%   
  group_by(month_stop, boro) %>% 
  summarize(
    count = n()
  ) %>% 
  ggplot(aes(x = month_stop, y = count, color = boro)) + 
  geom_point() +
  geom_smooth(se = FALSE) 

# Number of stops per hour over the day
stop_frisk_df %>% 
  mutate(
    hour_stop = hour(time_stop),
    part_of_day = cut(hour_stop, breaks = c(0, 5, 12, 17, 21, 24), labels = c("Night", "Morning", "Afternoon", "Evening", "Night"), right = FALSE)
  ) %>% 
  select(hour_stop, part_of_day) %>% 
  group_by(hour_stop, part_of_day) %>% 
  summarize(
    count = n()
  ) %>% 
  ggplot(aes(x = hour_stop, y = count)) + 
  geom_bar(stat = "Identity", aes(fill = part_of_day)) +
  geom_smooth(se = FALSE)

# Number of stops per hour over the day (broken down by boro)
stop_frisk_df %>% 
  mutate(
    hour_stop = hour(time_stop)
  ) %>% 
  group_by(hour_stop, boro) %>% 
  summarize(
    count = n()
  ) %>% 
  ggplot(aes(x = hour_stop, y = count, color = boro)) + 
  geom_point() +
  geom_smooth(se = FALSE)
```

This code chunk looks at the number of people stopped, frisked, frisked & searched, and searched over a single day

```{r, message=FALSE}
stop_frisk_df %>% 
  filter(date_stop != is.na(date_stop)) %>% 
  mutate(
    hour_stop = hour(time_stop)
  ) %>% 
  group_by(hour_stop, frisked, searched) %>% 
  summarize(
    count = n()
  ) %>% 
  pivot_wider(
    names_from = frisked:searched,
    values_from = count
  ) %>% 
  rename(
    "stopped" = "0_0",
    "frisked" = "1_0",
    "searched" = "0_1",
    "frisk_and_search" = "1_1"
  ) %>% 
  mutate(
    searched = replace_na(searched, 0),
    stopped = replace_na(stopped, 0),
    frisked = replace_na(frisked, 0),
    frisk_and_search = replace_na(frisk_and_search, 0),
    stopped = stopped + searched + frisked + frisk_and_search
  ) %>% 
  ggplot(aes(x = hour_stop, y = stopped)) +
  geom_smooth(se = FALSE, color = 'red') +
  geom_smooth(aes(y = frisked, color = 'blue'), se = FALSE) +
  geom_smooth(aes(y = searched, color = 'green'), se = FALSE) +
  geom_smooth(aes(y = frisk_and_search, color = 'yellow'), se = FALSE) 
```




















Logistic Regression Dataset
    
```{r, message=FALSE}
stop_frisk_log = stop_frisk_df %>% mutate(
    race = recode(
      race, 
      "asian/pacific islander" = "other", 
      "black" = "black", 
      "american indian/alaska native" = "other",
      "black-hispanic" = "black-hispanic",
      "white-hispanic" = "white-hispanic",
      "white" = "white",
      "unknown" = "other",
      "other" = "other"
    ),
    hair_col = recode(
      hair_col,
      "dyed" = "other",
      "frosted" = "other",
      "gray" = "other",
      "red" = "other",
      "sandy" = "other",
      "salt and pepper" = "other",
      "white" = "other",
      "unknown" = "other",
      "ZZ" = "other"
    ),
    eye_col = recode(
      eye_col,
      "different" = "other",
      "green" = "other",
      "gray" = "other",
      "hazel" = "other",
      "maroon" = "other",
      "pink" = "other",
      "violet" = "other",
      "unknown" = "other"
    ),
    build = recode(
      build,
      "muscular" = "other",
    ))

```

  
```{r}
model_1 = glm(frisked ~ sex + race + age + height_inch + weight + hair_col + eye_col + boro + build + stop_in_out + precinct + off_in_unif + cs_objcs + cs_descr + cs_casng + cs_lkout + cs_cloth + cs_drgtr + cs_furtv + cs_vcrim+ cs_bulge + cs_other, family = binomial, data = stop_frisk_log)

car::vif(model_1)
# Based on the GVIF, we will remove boro

model_2 = glm(frisked ~ sex + race + age + height_inch + weight + hair_col + eye_col + build + stop_in_out + precinct + off_in_unif + cs_objcs + cs_descr + cs_casng + cs_lkout + cs_cloth + cs_drgtr + cs_furtv + cs_vcrim+ cs_bulge + cs_other, family = binomial, data = stop_frisk_log)

car::vif(model_2)
# no more collinearity problems

summary(model_2)
# Remove hair and eye color because all categories within them are highly unsignificant, cs_drgtr, cs_lkout

model_3 = glm(frisked ~ sex + race + age + height_inch + weight + build + stop_in_out + precinct + off_in_unif + cs_objcs + cs_descr + cs_casng + cs_cloth + cs_furtv + cs_vcrim+ cs_bulge + cs_other, family = binomial, data = stop_frisk_log)

summary(model_3)
# remove weight, cs_cloth, cs_objcs
model_4 = glm(frisked ~ sex + race + age + height_inch + build + stop_in_out + precinct + off_in_unif + cs_descr + cs_casng + cs_furtv + cs_vcrim+ cs_bulge + cs_other, family = binomial, data = stop_frisk_log)

summary(model_4)
anova(model_4, model_3, test = "Chisq")
```


Building a model that uses characteristics, demographics, and location as predictors for arrest made
```{r}
model_5 = glm(arst_made ~ sex + race + age + height_inch + weight + hair_col + eye_col + build + stop_in_out + precinct + off_in_unif, family = binomial, data = stop_frisk_log)

car::vif(model_5)

summary(model_5)

# remove eye color and build 
model_6 = glm(arst_made ~ sex + race + age + height_inch + weight + hair_col+ stop_in_out + precinct + off_in_unif, family = binomial, data = stop_frisk_log)

summary(model_6)

# remove height, age
model_7 = glm(arst_made ~ sex + race + weight + hair_col+ stop_in_out + precinct + off_in_unif, family = binomial, data = stop_frisk_log)

summary(model_7)

```


Creating Training and Testing datasets and use the selected models to create AOC
```{r}
train = sample_frac(stop_frisk_log, size = 0.8)
test = anti_join(stop_frisk_log, train)

library(caret)

# predict results for arrest made model
model_7_pred = glm(arst_made ~ sex + race + weight + stop_in_out + precinct + off_in_unif + hair_col, family = binomial, data = train)

log_pred = predict(model_7_pred, newdata = test, type = "response")

log_pred = ifelse(log_pred > 0.5, 1, 0)

library(ROCR)
library(Metrics)

pr = prediction(log_pred, test$arst_made)
perf = performance(pr, measure = "tpr", x.measure = "fpr")
plot(perf)

auc(test$arst_made, log_pred)



# predict results for frisked model
model_4_pred = glm(frisked ~ sex + race + age + height_inch + build + stop_in_out + precinct + off_in_unif + cs_descr + cs_casng + cs_furtv + cs_vcrim+ cs_bulge + cs_other, family = binomial, data = train)

log_pred = predict(model_4_pred, newdata = test, type = "response")

log_pred = ifelse(log_pred > 0.5, 1, 0)

library(ROCR)
library(Metrics)

pr = prediction(log_pred, test$frisked)
perf = performance(pr, measure = "tpr", x.measure = "fpr")
plot(perf)

auc(test$frisked, log_pred)
```



LASSO Frisked
```{r}
library(glmnet)

set.seed(1)

# getting rid of incomplete observations
stop_frisk_lasso = stop_frisk_log[complete.cases(stop_frisk_log), ]

# keeping only variables we want to use with frisked logistic prediction
stop_frisk_lasso = stop_frisk_lasso %>% select(frisked, sex, race, age, height_inch, weight, hair_col, eye_col, build, stop_in_out, precinct, off_in_unif, cs_objcs, cs_descr, cs_casng, cs_lkout, cs_cloth, cs_drgtr, cs_furtv, cs_vcrim, cs_bulge, cs_other)

# create test and train datasets
train_lasso = sample_frac(stop_frisk_lasso, size = 0.5)
test_lasso = anti_join(stop_frisk_lasso, train_lasso)

# creating x and y
x = model.matrix(frisked ~ ., train_lasso)[,-1]
y = train_lasso$frisked

# lasso fit
lasso_fit = glmnet(x, y, family = "binomial")

# cross validation
lasso_cv = cv.glmnet(x, y, family = "binomial", type = "mse")

lambda_opt = lasso_cv$lambda.min

# visualizing best lambda
broom::tidy(lasso_fit) %>% 
  select(term, lambda, estimate) %>% 
  complete(term, lambda, fill = list(estimate = 0) ) %>% 
  filter(term != "(Intercept)") %>% 
  ggplot(aes(x = log(lambda, 10), y = estimate, group = term, color = term)) + 
  geom_path() + 
  geom_vline(xintercept = log(lambda_opt, 10), color = "blue", size = 1.2) +
  theme(legend.position = "none")

broom::tidy(lasso_cv) %>% 
  ggplot(aes(x = log(lambda, 10), y = estimate)) + 
  geom_point()  

# coefficients from the optimal model
lasso_fit = glmnet(x, y, lambda = lambda_opt)
lasso_fit %>% broom::tidy()
```

Testing data
```{r}
#min value of lambda
lambda_min <- lasso_cv$lambda.min
#best value of lambda
lambda_1se <- lasso_cv$lambda.1se
#regression coefficients
coef(lasso_cv, s = lambda_1se)

#get test data
x_test <- model.matrix(frisked ~ ., test_lasso)
x_test = x_test[,-1]

#predict class, type=”class”
lasso_prob <- predict(lasso_cv, newx = x_test, s = lambda_1se, type = "response")

#translate probabilities to predictions
lasso_predict <- rep("neg", nrow(test_lasso))
lasso_predict[lasso_prob > 0.5] <- "pos"

#confusion matrix
table(pred = lasso_predict, true = test_lasso$frisked)

auc(test_lasso$frisked, lasso_predict)
```

LASSO Arrested
```{r}
# getting rid of incomplete observations
stop_frisk_lasso_arst = stop_frisk_log[complete.cases(stop_frisk_log), ]

# keeping only variables we want to use with frisked logistic prediction
stop_frisk_lasso_arst = stop_frisk_lasso_arst %>% select(arst_made, sex, race, age, height_inch, weight, hair_col, eye_col, build, stop_in_out, precinct, off_in_unif)


# create test and train datasets
train_lasso_arst = sample_frac(stop_frisk_lasso_arst, size = 0.5)
test_lasso_arst = anti_join(stop_frisk_lasso_arst, train_lasso_arst)

# creating x and y
x = model.matrix(arst_made ~ ., train_lasso_arst)[,-1]
y = train_lasso_arst$arst_made

# lasso fit
lasso_fit = glmnet(x, y, family = "binomial")

# cross validation
lasso_cv = cv.glmnet(x, y, family = "binomial", type = "mse")

lambda_opt = lasso_cv$lambda.min

# visualizing best lambda
broom::tidy(lasso_fit) %>% 
  select(term, lambda, estimate) %>% 
  complete(term, lambda, fill = list(estimate = 0) ) %>% 
  filter(term != "(Intercept)") %>% 
  ggplot(aes(x = log(lambda, 10), y = estimate, group = term, color = term)) + 
  geom_path() + 
  geom_vline(xintercept = log(lambda_opt, 10), color = "blue", size = 1.2) +
  theme(legend.position = "none")

broom::tidy(lasso_cv) %>% 
  ggplot(aes(x = log(lambda, 10), y = estimate)) + 
  geom_point()  

# coefficients from the optimal model
lasso_fit = glmnet(x, y, lambda = lambda_opt)
lasso_fit %>% broom::tidy()
```


Tsting the data
```{r}
#min value of lambda
lambda_min <- lasso_cv$lambda.min
#best value of lambda
lambda_1se <- lasso_cv$lambda.1se
#regression coefficients
coef(lasso_cv, s = lambda_1se)

#get test data
x_test <- model.matrix(arst_made ~ ., test_lasso_arst)
x_test = x_test[,-1]

#predict class, type=”class”
lasso_prob <- predict(lasso_cv, newx = x_test, s = lambda_1se, type = "response")

#translate probabilities to predictions
lasso_predict <- rep("neg", nrow(test_lasso_arst))
lasso_predict[lasso_prob > 0.5] <- "pos"

#confusion matrix
table(pred = lasso_predict, true = test_lasso_arst$arst_made)

auc(test_lasso_arst$arst_made, lasso_predict)
```




```{r}
stop_frisk_log %>% group_by(frisked, searched, arst_made) %>% 
  summarise(
    n_obs = n())
```


```{r, demographics, eval = FALSE}

# count per sex group
demographics = stop_frisk_log %>% 
  select(sex:build, height_inch, frisked, searched) 

# count subjects by sex
demographics %>% 
  group_by(sex) %>% 
  summarize(count = n()) %>% 
  knitr::kable()
  
# distribution of age by sex
demographics %>% 
  plot_ly(y = ~ age, color = ~sex, type = "violin", colors = "Set2")

  
# subjects count of frisked subjects by race, sex 
frisked_plot = 
  stop_frisk_df %>% 
  drop_na() %>% 
  mutate(
    race = fct_infreq(race)
    ) %>% 
  filter( 
    frisked == '1') %>% 
  ggplot(aes(x = race, fill = sex))+
  geom_bar(alpha = .5, position = "dodge")+
  labs(
    title = "Frisked")+
  theme(axis.text.x = element_text(angle = 80, hjust = 1))

# subjects count of searched subjects by race, sex
searched_plot = 
  stop_frisk_df  %>% 
  drop_na() %>% 
  mutate(
    race = fct_infreq(race)) %>% 
  filter(searched =='1') %>% 
  ggplot(aes(x = race, fill = sex))+
  geom_bar(alpha = .5, position = "dodge")+
  labs(
    title = "Searched")+
  theme(axis.text.x = element_text(angle = 80, hjust = 1))

# subjects count of arrested subjects by race, sex
arrested_plot = 
  stop_frisk_df  %>% 
  drop_na() %>% 
  mutate(
    race = fct_infreq(race)) %>% 
  filter(arst_made =='1') %>% 
  ggplot(aes(x = race, fill = sex))+
  geom_bar(alpha = .5, position = "dodge")+
  labs(
    title = "Arrested")+
  theme(axis.text.x = element_text(angle = 80, hjust = 1))

# devtools::install_github("thomasp85/patchwork")
library(patchwork)

(frisked_plot+searched_plot + arrested_plot)
```

Regression model for demographics

```{r, eval=FALSE}
dem_model = glm(arst_made ~ sex:build + height_inch, family = binomial, data = stop_frisk_log)
summary(dem_model)
car::vif(dem_model)
# nothing is sig

arrest_model = glm(arst_made ~ sex + age + weight, family = binomial, data = stop_frisk_log)
summary(arrest_model)
__________________________
# did not want to change the whole dataset. Releveles arst_made, so regression models outcome arrested 

stop_frisk_relevel = 
  stop_frisk_log %>% 
  mutate(
    arst_made = as.factor(arst_made),
    arst_made = fct_relevel(arst_made, '1'))
  
arrest_model_2 = 
  glm(arst_made ~ sex + age + weight, family = binomial, data = stop_frisk_relevel)
summary(arrest_model_2)
```


Stops of subjects below 18
```{r}
stop_frisk_log %>% 
  filter(
    age < '18') %>% 
  group_by(sex, race) %>% 
  summarize(count = n()) %>% 
  knitr::kable()

# frisked under 18 by race
stop_frisk_log %>% 
  filter(
    age < '18',
    frisked == '1') %>% 
  group_by( race) %>% 
  summarize(count = n()) %>% 
  knitr::kable()

#searched under 18
stop_frisk_log %>% 
  filter(
    age < '18',
    searched == '1') %>% 
  group_by( race) %>% 
  summarize(count = n()) %>% 
  knitr::kable()

#arrested under 18
stop_frisk_log %>% 
  filter(
    age < '18',
    arst_made =='1') %>% 
  group_by(race) %>% 
  summarize(count = n()) %>% 
  knitr::kable()

# bar chart for age below 18 for each race
stop_frisk_log %>% 
  filter(
    age < '18') %>%
  ggplot(aes(x = race, fill = race))+
  geom_bar()


#violin plot of age below 18 for each race
stop_frisk_log %>% 
  filter(
    age < '18') %>%
  plot_ly(y = ~age, color = ~race, type = "violin", colors = "Set2")

# weapon found on a child (<18)
# top reasons for stopping children
  
```



## Converting X Y Coordinates
```{r}
test_df= 
  stop_frisk_df %>% 
  select(xcoord, ycoord) %>% 
  drop_na()

coordinates(test_df) <- c("xcoord","ycoord")
proj4string(test_df) <- CRS("+init=epsg:2263")
CRS.new <- CRS("+init=epsg:4326") 
test_df_new <- spTransform(test_df, CRS.new)
test_df_new <- data.frame(longitude = coordinates(test_df_new)[,1], latitude = coordinates(test_df_new)[,2])
```

# Simplifying code
```{r}
long_lat_df =
  stop_frisk_df %>% 
  select(xcoord, ycoord) %>% 
  drop_na()

coordinates(long_lat_df) <- c("xcoord", "ycoord")
proj4string(long_lat_df) <- CRS("+init=epsg:2263")
long_lat_df <- spTransform(long_lat_df, CRS("+init=epsg:4326"))
long_lat_df <- data.frame(longitude = coordinates(long_lat_df)[,1], latitude = coordinates(long_lat_df)[,2])
```














